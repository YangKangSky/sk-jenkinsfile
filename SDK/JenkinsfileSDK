def params = {}
def repo_url
def repo_manifest
def repo_branch
def distro_features
def target_image
def build_param
def use_sstate_cache
def machine_name
def patchlist
	

pipeline {
    agent {
        label '203.11'
    }

    stages {
		stage('GetParam') {
		  steps {
			script {
				params = properties([])
				repo_url = params.REPOURL
				repo_manifest = params.MANIFEST
				repo_branch = params.BRANCH
				distro_features = params.DISTRO_FEATURES
				target_image = params.TARGET_IMAGE
				build_param = params.BUILD_PARAM
				use_sstate_cache = params.USE_SSTATE_CACHE
				machine_name = params.MACHINE_NAME
				patchlist = params.PATCHLIST
			  
				println "repo_url is: ${repo_url}"
				println "repo_manifest is: ${repo_manifest}"
				println "repo_branch is: ${repo_branch}"
				println "distro_features is: ${distro_features}"
				println "target_image is: ${target_image}"
				println "build_param is: ${build_param}"
				println "use_sstate_cache is: ${use_sstate_cache}"
				println "machine_name is: ${machine_name}"
				println "patchlist is: ${patchlist}"
			}
		  }
		}
	
        stage('Prepare') {
            steps {
                script {
					// 准备
					
					def branch = params.BRANCH
					println "Branch is: ${branch}"
					
					sh "echo 'shell scripts to Prepare project 1...'"
					def jenkinsfilePath = pwd()  // 获取当前路径
					def scriptPath = "${jenkinsfilePath}/SDK/sdk_build.sh"  // 组合路径和脚本名称

					dir(jenkinsfilePath) {
						sh "${scriptPath} prepare"
					}
                }
            }
        }
	
        stage('Checkout') {
            steps {
                script {
					// 检出代码
					sh "echo 'shell scripts to Checkout project...'"
					def jenkinsfilePath = pwd()  // 获取当前路径
					def scriptPath = "${jenkinsfilePath}/SDK/sdk_build.sh"  // 组合路径和脚本名称
					dir(jenkinsfilePath) {
						sh "${scriptPath} sync"
					}
                }
            }
        }

        stage('Build') {
            steps {
                script {
					// 构建命令
					sh "echo 'shell scripts to Build project...'"
					def jenkinsfilePath = pwd()  // 获取当前路径
					def scriptPath = "${jenkinsfilePath}/SDK/sdk_build.sh"  // 组合路径和脚本名称
					dir(jenkinsfilePath) {
						sh "${scriptPath} build"
					}
                }
            }
        }

	stage('Test') {
            steps {
                parallel(
                    "Test Suite 1": {
                        // 执行测试套件 1
                        sh "echo 'shell scripts to run Test Suite 1...'"
                    },
                    "Test Suite 2": {
                        // 执行测试套件 2
                        sh "echo 'shell scripts to run unit Test Suite 2...'"
                    },
                    "Test Suite 3": {
                        // 执行测试套件 3
                        sh "echo 'shell scripts to run integration Test Suite 3...'"
                    }
                )
            }
        }

        stage('Deploy') {
            steps {
                // 部署构建结果
                // 在此处添加您的部署步骤，如将构建的二进制文件下载到目标设备等
				sh "echo 'shell scripts to deploy to server...'"
            }
        }
    }

    post {
        success {
            echo '构建成功'
        }
        failure {
            echo '构建失败'
        }
    }
}

